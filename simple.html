<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Chatアプリ</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- コンテンツ表示画面 -->

    <div>
        <div>
            名前: <input type="text" id="uname">
        </div>
        <div>
            <textarea name="" id="text" cols="30" rows="10"></textarea>
            <button id="send">送信</button>
        </div>
        <div id="output"></div>
    </div>

    <!--/ コンテンツ表示画面 -->



    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- JQuery -->


    <!--** 以下Firebase **-->

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
            from "https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCsOSw3tK4jdS8FWXposTERyYX7A0VM5-c",
            authDomain: "fir-demo-1bc12.firebaseapp.com",
            projectId: "fir-demo-1bc12",
            storageBucket: "fir-demo-1bc12.appspot.com",
            messagingSenderId: "973301401540",
            appId: "1:973301401540:web:9b5a3a661fee08da114691"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Realtime DBに接続
        const db = getDatabase(app); // RealtimeDBに接続
        const dbRef = ref(db, "chat"); // RealtimeDB内の"chat"を使う

        // 送信ボタンが押されたら、データをDBに送信
        $("#send").on("click", function () {
            const msg = {
                uname: $("#uname").val(),
                text: $("#text").val()
            }
            const newPostRef = push(dbRef); // pushできる状態にする
            set(newPostRef, msg); // DBに値を送信
        });

        // Enterが押されたら、データをDBに送信
        $("#text").on("keydown", function (e) {
            if (e.keyCode == 13) {
                const msg = {
                    uname: $("#uname").val(),
                    text: $("#text").val()
                }
                const newPostRef = push(dbRef); // pushできる状態にする
                set(newPostRef, msg); // DBに値を送信
            }
        });

        // 既存アイテムのリストを取得した後、アイテムリストへの追加がある度に発火する
        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            const key = data.key;
            // let h = "<p class='message'>";
            // h += msg.uname;
            // h += "<br>";
            // h += msg.text;
            // h += "<br><button class='delete-button'>削除</button>"
            // h += "</p>";
            $("#output").append(`<div id="${key}"><div><p>${msg.uname}:${msg.text}</p><button class="remove">削除</button></div><div><button class = "like">いいね！</button></div></div>`); // #output の最後に追加
            // console.log(h);
            // 削除ボタンを押したときの処理
            // 削除ボタンと一緒に表示されているメッセージを削除する
            //削除ボタンと一緒にいいねボタンといいね数を削除する


        });

        $(".remove").on("click", function () {
            console.log("aaa");
            const id = $(this).parent().parent().attr("id");
            const comment = document.getElementById(id);
            console.log(id);
            comment.remove();
            //データベースからも削除する
            remove(ref(db, "chat/" + id));
        });

        // function onDeleteButtonClick(key) {
        //     localStorage.removeItem(key);
        //     refreshList();
        // }



        // $(".remove").on("click", function () {
        //     console.log("aaa");
        // })











        // 削除ボタンが押されたら、対象チャットを削除
        // 削除ボタンのクリックイベントを処理
        // $(".delete-button").on("click", function () {
        // var messageId = $(this).data("message-id");
        // console.log("aaa");
        // var d = $(this).closest(".message");

        // // Firestoreのメッセージドキュメントを削除
        // db.collection("messages").doc(messageId).delete()
        //     .then(function () {
        //         console.log("メッセージの削除に成功しました。");
        //     })
        //     .catch(function (error) {
        //         console.error("メッセージの削除に失敗しました。", error);
        //     });
        // });

        // 既存アイテムのリストを取得した後、アイテムリストからの削除がある度に発火する
        // onChildRemoved(dbRef, function (snapshot) {
        //     const msg = data.val();
        //     const key = data.key;
        //     let h = "<p class='tweet'>";
        //     h += msg.uname;
        //     h += "<br>";
        //     h += msg.text;
        //     h += "<br><button class='delete-button'>削除</button>"
        //     h += "</p>";
        //     $("#output").append(h); // #output の最後に追加
        // });



    </script>











</body>

</html>